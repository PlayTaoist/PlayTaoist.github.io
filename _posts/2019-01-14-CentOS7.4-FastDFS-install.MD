---
title:  "CentOS7 安装FastDFS分布式文件系统"
categories: CentOS7 FastDFS
tags: CentOS7 FastDFS
author: LIUREN
---

## CentOS7 安装FastDFS分布式文件系统

> 最近要用到fastDFS，所以自己研究了一下，在搭建FastDFS的过程中遇到过很多的问题，为了能帮忙到以后搭建FastDFS的同学，少走弯路，与大家分享一下。FastDFS的作者淘宝资深架构余庆，这个优秀的轻量及的分布式文件系统的开源没多久，立马就火了。
>
> FastDFS是为互联网应用量身定做的一套分布式文件存储系统，非常适合用来存储用户图片、视频、文档等文件



## 版本介绍

```shell
系统：centos7.4

FastDFS：5.11

libfastcommon：1.0.39 

fastdfs-nginx-module：1.20

nginx：1.14.1
```



## 一.FastDFS搭建工具下载

作者的GitHub地址：<https://github.com/happyfish100> 

这次搭建的所有工具，都可以在上面下载到。我搭建的是目前最新版本Version 5.11 2017-05-26

**Version 5.11对应的fastdfs-nginx-module的Version 1.20 **
**Version 5.10对应的fastdfs-nginx-module的Version 1.19**



**之所以在安装前写了这么一段话，是因为这个很重要，版本不对应会给接下来的安装带来各种问题。**

![](https://www.codepeople.cn/imges/FastDFS/001.png)

**把源码下载下来3个zip包，再去下个nginx：**

![](https://www.codepeople.cn/imges/FastDFS/001-001.png)

**注意：** 下载的时候要下`fastdfs-5.11.zip`  这个是没有错误的。如果下载 `fastdfs-5.11.tar.gz` 编译安装会报错；对于`fastdfs-nginx-module-1.20.zip`也要下载`zip`结尾的，不然编译和安装会有问题。

当然可以直接去官网去下载，但是官网上不是最新的。

## 二：安装需要用到的应用与类库

首先安装所需的基础依赖

```shell
yum install vim wget zlib zlib-devel pcre pcre-devel gcc gcc-c++ openssl openssl-devel libevent libevent-devel perl net-tools unzip
```



## 三：添加用户：

```shell
[root@localhost /]# groupadd fastdfs
[root@localhost /]# useradd -s /sbin/nologin -g fastdfs fastdfs
```



## 四：创建目录

```shell
[root@localhost /]# mkdir -p /usr/local/FastDFS
[root@localhost /]# mkdir -p /data/fastdfs/storage
[root@localhost /]# chown -R fastdfs:fastdfs /data/fastdfs
```

![](https://www.codepeople.cn/imges/FastDFS/002.png)

## 五：通过工具把文件上传到"/usr/local/FastDFS"中,并解压

解压命令如下：

```shell
unzip fastdfs-nginx-module-1.20.zip
unzip fastdfs-5.11.zip
tar -zvxf libfastcommon-1.0.39.tar.gz
```

![](https://www.codepeople.cn/imges/FastDFS/003.png)

## 六：安装libfastcommon

进入到解压的libfastcommon-1.0.39.tar.gz

```shell
[root@localhost FastDFS]# cd libfastcommon-1.0.39
[root@localhost libfastcommon-1.0.39]# ./make.sh
[root@localhost libfastcommon-1.0.39]# ./make.sh install
```

libfastcommon默认会被安装到/usr/lib64/libfastcommon.so但是FastDFS的主程序却在/usr/local/lib目录下 
这个时候我们就要建立一个软链接了，实际上也相当于windows上的快捷方式。

```shell
ln -s /usr/lib64/libfastcommon.so /usr/local/lib/libfastcommon.so
ln -s /usr/lib64/libfastcommon.so /usr/lib/libfastcommon.so
ln -s /usr/lib64/libfdfsclient.so /usr/local/lib/libfdfsclient.so
ln -s /usr/lib64/libfdfsclient.so /usr/lib/libfdfsclient.so
```



## 七：解压FastDFS安装包

进入fastdfs-5.11文件夹中

```shell
[root@localhost FastDFS]# cd fastdfs-5.11
[root@localhost fastdfs-5.11]# ./make.sh
[root@localhost fastdfs-5.11]# ./make.sh install
```

安装成功后copy一下配置文件

```shell
[root@localhost fastdfs-5.11]# cp conf/* /etc/fdfs/
```

如果下载的是`fastdfs-5.11.tar.gz `安装的时候会报如下错误：

![](https://www.codepeople.cn/imges/FastDFS/004.png)



## 八：配置FastDFS文件

进入`/etc/fdfs`目录下修改配置

①修改`tracker.conf`

```shell
[root@localhost fastdfs-5.11]# cd /etc/fdfs/
[root@localhost fastdfs-5.11]# vim tracker.conf
```

主要修改内容如下：

```shell
bind_addr=0.0.0.0
base_path=/data/fastdfs/storage
http.server_port=80
```

②修改`storage.conf`

```shell
[root@localhost fastdfs-5.11]# vim storage.conf
```

主要修改内容如下：

```shell
bind_addr=0.0.0.0
base_path=/data/fastdfs/storage
store_path0=/data/fastdfs/storage
# ip地址是你FastDFS服务器的地址
tracker_server=192.168.0.137:22122
http.server_port=80
```

③修改`client.conf`

```shell
[root@localhost fastdfs-5.11]# vim client.conf
```

主要修改内容如下：

```shell
base_path=/data/fastdfs/storage
tracker_server=192.168.0.137:22122
http.tracker_server_port=80
```



## 九：授权对应的端口开放

```shell
firewall-cmd --zone=public --add-port=80/tcp --permanent
firewall-cmd --zone=public --add-port=22122/tcp --permanent
firewall-cmd --zone=public --add-port=23000/tcp --permanent
firewall-cmd --reload
firewall-cmd --list-all
```



## 十：启动`tracker`和`storage`服务

启动`tracker`和`storage`服务

```shell
[root@localhost fdfs]# service fdfs_trackerd start
Starting fdfs_trackerd (via systemctl):                    [  确定  ]
[root@localhost fdfs]# service fdfs_storaged start
Starting fdfs_storaged (via systemctl):                    [  确定  ]
```



## 十一：测试文件上传

首先：需要我们使用工具上传一张图片到`/usr/local/IMG_0076.JPG`

然后执行如下命令：

```shell
[root@localhost fdfs]# /usr/bin/fdfs_test /etc/fdfs/client.conf upload /home/ucenter/soft/IMG_0076.JPG
```

![](https://www.codepeople.cn/imges/FastDFS/010.png)

由于现在还没有和nginx整合无法使用http下载。



## 十二：FastDFS 和nginx整合

```shell
安装之前，最好检查一下是否已经安装有nginx
# find -name nginx  
如果系统已经安装了nginx，那么就先卸载
# yum remove nginx
```

#### 新建一个用户

```shell
需要新建一个用户，禁止使用root用户进行操作
# useradd  -d ucenter
# passwd ucenter
# cd /ucenter
# mkdir soft
# chown ucenter:ucenter /ucenter/ -R
```

#### 在soft目录下直接下载和安装nginx

```shell
$ cd /home/ucenter/soft
$ mkdir nginx
$ wget http://nginx.org/download/nginx-1.14.1.tar.gz
#解压nginx压缩包
$ tar -vxf nginx-1.14.1.tar.gz
#解压后会产生一个nginx-1.14.1的目录，进入这个目录
$ cd nginx-1.14.1
```

#### 切换到root目录，然后指定默认的安装目录

```shell
./configure --prefix=/home/ucenter/soft/nginx  --with-http_stub_status_module --with-http_ssl_module --with-http_realip_module  --add-module=/usr/local/FastDFS/fastdfs-nginx-module-1.20/src/ --user=ucenter --group=ucenter
```

` /usr/local/FastDFS/fastdfs-nginx-module-1.20/src/`是`fastdfs-nginx-module-1.20.zip`解压的目录

`--prefix=/home/ucenter/soft/nginx`是指编译然后安装到此目录下

`--user=ucenter --group=ucenter` 给nginx分配用户和分组

#### 再次切换用户到ucenter,然后进入nginx-1.14.1目录下进行编译安装

```shell
$ make
$ make install
```

#### 编译完毕后进入到编译好的nginx目录

```shell
[root@localhost conf]# cd /home/ucenter/soft/nginx/conf
[root@localhost conf]# vim nginx.conf
```

修改内容如下：

```nginx
#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

    server {
        listen       80;
        server_name  192.168.0.137;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location /group1/M00/ {
            #root   html;
            #index  index.html index.htm;
            root /data/fastdfs/storage/data;
            ngx_fastdfs_module;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        # proxy the PHP scripts to Apache listening on 127.0.0.1:80
        #
        #location ~ \.php$ {
        #    proxy_pass   http://127.0.0.1;
        #}

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ \.php$ {
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #    deny  all;
        #}
    }


    # another virtual host using mix of IP-, name-, and port-based configuration
    #
    #server {
    #    listen       8000;
    #    listen       somename:8080;
    #    server_name  somename  alias  another.alias;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}


    # HTTPS server
    #
    #server {
    #    listen       443 ssl;
    #    server_name  localhost;

    #    ssl_certificate      cert.pem;
    #    ssl_certificate_key  cert.key;

    #    ssl_session_cache    shared:SSL:1m;
    #    ssl_session_timeout  5m;

    #    ssl_ciphers  HIGH:!aNULL:!MD5;
    #    ssl_prefer_server_ciphers  on;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}

}

```

#### 安装完毕后，启动nginx

```shell
$ cd /home/ucenter/soft/nginx
$ cd sbin
$ ./nginx
```

#centos中启动，重新加载，停止命令如下

```shell
./nginx    -------开启nginx服务
./nginx -s reload ----------重新加载nginx服务
./nginx -s stop ----------关闭nginx服务
```

或者

```shell
pkill -9 nginx  ---------- 杀死所有的nginx进城
```

##### 要到问题需要注意：

```shell
centos7 nginx: [emerg] bind() to 0.0.0.0:80 failed (13: Permission denied)
```

如果切换到普通用户下启动，有可能会报这个错误，怎么解决了？

执行如下命令：

```shell
$ su root
$ passwd --输入密码
# cd /ucenter/soft/nginx/sbin/
# ll 
# chown root nginx
# chmod u+s nginx
# ll
# su ucenter
$ ./nginx
$ ps -ef|grep nginx
```

#### 如何结束掉nginx进程

```shell
#一般情况下直接可以直接使用nginx的自带命令
$ ./nginx -s stop
#如果命令不起作用则可以使用
$ ps -ef | grep nginx
root      13064      1  0 16:46 ?        00:00:00 nginx: master process ./nginx
ucenter   13065  13064  0 16:46 ?        00:00:00 nginx: worker process
ucenter   13069  12602  0 16:46 pts/2    00:00:00 grep --color=auto nginx
#然后分别杀死主进程和分进程
$ kill -9 13064
$ kill -9 13065
#或者可以通过如下命令直接停止
$ pkill -9 nginx
```



## 如果防火墙设置好了，就可以直接在浏览器中访问了

![](https://www.codepeople.cn/imges/FastDFS/011.png)

![](https://www.codepeople.cn/imges/FastDFS/012.png)

访问的地址是如下：<http://192.168.0.137/group1/M00/00/00/wKgAiVxH6ZmAaDnwAAEpShblOro831_big.JPG>



=======================================================================================

## 其中遇到的错误问题如下：

#### 第一个问题：

![](https://www.codepeople.cn/imges/FastDFS/004.png)

这个问题是因为没有安装依赖：所以要执行

```shell
yum install vim wget zlib zlib-devel pcre pcre-devel gcc gcc-c++ openssl openssl-devel libevent libevent-devel perl net-tools unzip
```

#### 第二个问题：

![](https://www.codepeople.cn/imges/FastDFS/005.png)

所下载的`fastdfs-5.11.tar.gz`或者`fastdfs-5.11.zip`有问题，需要重新下载

#### 第三个问题：

![](https://www.codepeople.cn/imges/FastDFS/007.png)

这个问题一般出现在高版本中，这个问题需要手动修改`fastdfs-nginx-module-1.20/src/config`文件

```shell
vim fastdfs-nginx-module-1.20/src/config
```

修改后文件如下：

```shell
ngx_addon_name=ngx_http_fastdfs_module

if test -n "${ngx_module_link}"; then
    ngx_module_type=HTTP
    ngx_module_name=$ngx_addon_name
    ngx_module_incs="/usr/include/fastdfs /usr/include/fastcommon/"
    ngx_module_libs="-lfastcommon -lfdfsclient"
    ngx_module_srcs="$ngx_addon_dir/ngx_http_fastdfs_module.c"
    ngx_module_deps=
    CFLAGS="$CFLAGS -D_FILE_OFFSET_BITS=64 -DFDFS_OUTPUT_CHUNK_SIZE='256*1024' -DFDFS_MOD_CONF_FILENAME='\"/etc/fdfs/mod_fastdfs.conf\"'"
    . auto/module
else
    HTTP_MODULES="$HTTP_MODULES ngx_http_fastdfs_module"
    NGX_ADDON_SRCS="$NGX_ADDON_SRCS $ngx_addon_dir/ngx_http_fastdfs_module.c"
    CORE_INCS="$CORE_INCS /usr/include/fastdfs /usr/include/fastcommon/"
    CORE_LIBS="$CORE_LIBS -lfastcommon -lfdfsclient"
    CFLAGS="$CFLAGS -D_FILE_OFFSET_BITS=64 -DFDFS_OUTPUT_CHUNK_SIZE='256*1024' -DFDFS_MOD_CONF_FILENAME='\"/etc/fdfs/mod_fastdfs.conf\"'"
fi

```

主要修改部分是

`ngx_module_incs="/usr/include/fastdfs /usr/include/fastcommon/"`

`CORE_INCS="$CORE_INCS /usr/include/fastdfs /usr/include/fastcommon/"`

然后保存后重新编译nginx就可以了

#### 第四个问题：

![](https://www.codepeople.cn/imges/FastDFS/008.png)

这个问题主要是`/etc/fdfs`下的`tracker.conf`或者是`storage.conf`配置错误，需要回去仔细核对然后再次重新启动`tracker`服务或者是`storage`服务

#### 第五个问题：开机启动问题

如果要把`tracker`,`storage`加入开机启动的话命令如下

```shell
# 设置tracker开机启动
echo "service fdfs_trackerd start" |tee -a /etc/rc.d/rc.local
# 设置storage开机启动
echo "service fdfs_storaged start" |tee -a /etc/rc.d/rc.local
```

查看一下tracker的端口监听情况

```shell
[root@localhost soft]# netstat -unltp|grep fdfs
tcp        0      0 0.0.0.0:23000           0.0.0.0:*               LISTEN      24261/fdfs_storaged 
tcp        0      0 0.0.0.0:22122           0.0.0.0:*               LISTEN      24078/fdfs_trackerd 
```

虚拟机每次重启都要重新启动fastdfs和nginx服务，比较麻烦，所以增加开机自启动；

编辑 /etc/rc.d/rc.local 文件，增加启动项；

1、编辑文件

```shell
vim /etc/rc.d/rc.local
```

2、增加如下：

```shell
# fastdfs start
service fdfs_trackerd start
service fdfs_storaged start

# nginx start
/usr/local/nginx/sbin/nginx
```

![](https://www.codepeople.cn/imges/FastDFS/013.png)

3、在centos7中, /etc/rc.d/rc.local 文件的权限被降低了，需要给rc.local 文件增加可执行的权限；

```shell
chmod +x /etc/rc.d/rc.local
```



=======================================================================================

微信公众号：

![](https://www.codepeople.cn/imges/weixin_icon/weixin.jpg)